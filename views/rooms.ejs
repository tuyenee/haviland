<h1><a href="/rooms" class="text-dark">Rooms</a></h1>

<%- include('partial/flash-messages', {messages: getMessages()}) %>

<div class="row">
    <% if(typeof currentUser != 'undefined' && currentUser.isAdmin()) { %>
        <div class="col-md-4 col-lg-2">
            <button type="button" class="btn btn-primary mt-3 mb-3" data-toggle="modal" data-target="#createRoomModal">Create new room</button>
        </div>
        <%-include('partial/manage-room-modal')%>
        <script>
            function confirmDeletion(roomId) {
                $('#deleteRoomModal input#roomId').val(roomId);
                $('#deleteRoomModal').modal('show');
                return false;
            }
        </script>
    <% } %>
    <div class="col-md-8 col-lg-10 mt-3">
        <form action="/rooms/search" method="POST" class="form-inline">
            <div class="form-row">
                <div class="col-auto">
                    <div class="input-group mb-2">
                        <div class="input-group-prepend">
                        <div class="input-group-text">Find rooms:</div>
                        </div>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="inlineFormInputGroup" 
                            placeholder="Address" 
                            name="search" 
                            value="<%- typeof search === 'string' ? search : '' %>"
                        />
                    </div>
                </div>
                <div class="col-auto">
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                            <div class="input-group-text">Price up to:</div>
                            </div>
                            <input 
                                type="number" 
                                class="form-control" 
                                id="filter-price" 
                                placeholder="Max price" 
                                name="maxPrice" 
                                value="<%- typeof maxPrice === 'string' ? maxPrice : '' %>"
                            />
                        </div>
                    </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary mb-2">Search</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- User listing -->
<% if(rooms.length) {%>
    <table class="table">
        <thead>
            <tr>
                <th>Building</th>
                <th>Address</th>
                <th>Room number</th>
                <th>Status</th>
                <th>Price vnd/month</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <% rooms.forEach((room) => {%>
                <tr id="<%=room.id%>">
                    <td><%=room.building%></td>
                    <td><%=room.address%></td>
                    <td>
                        <% if(typeof currentUser != 'undefined' && currentUser.isAdmin()) { %>
                            <a class="btn">
                                <%=room.number%>
                                <% if(typeof room.reservation != 'undefined' && room.reservation.length) { %>
                                    <span class="badge badge-primary badge-pill ml-2">
                                        <%= room.reservation.length %>
                                    </span>
                                <% } %>
                            </a>
                        <% } else { %>
                            <%=room.number%>
                        <% } %>
                    </td>
                    <td>
                        <% if(room.occupant) { %>
                            <% if(typeof currentUser != 'undefined' && room.occupant === currentUser.id) { %>
                                <span class="badge badge-success">Your room!</span>
                            <% } else { %>
                                <span class="badge badge-danger">Occupied</span>
                            <% } %>
                        <% } else { %>
                            <span class="badge badge-primary">Available</span>
                        <% } %>
                    </td>
                    <td><%=room.price%></td>
                    <td>
                        <% if(typeof currentUser != 'undefined' && currentUser.isAdmin()) { %>
                            <a href="/rooms/<%=room.id%>">View</a> |
                            <a href="#" onclick="confirmDeletion('<%=room.id%>')">Delete</a>
                        <% } else if(!room.occupant) { %>
                            <% if(typeof currentUser != 'undefined') { %>
                                <% if(typeof currentUser.reserving != 'undefined' && currentUser.reserving === room.id) { %>
                                    <a href="#" class="btn btn-outline-primary">Awaiting for confirmation</a>
                                <% } else if(!currentUser.reserving) { %>
                                    <button 
                                        class="btn btn-primary" 
                                        onclick="reserveRoom('<%=room.id%>')"
                                    >Reserve now!</button>
                                <% } %>
                            <% } else { %>
                                <button class="btn btn-primary" data-toggle="modal" data-target="#loginModal">Login & Reserve now!</button>
                            <% } %>
                        <% } %>
                    </td>
                </tr>
            <%})%>
        </tbody>
    </table>
<% } else { %>
<hr/>
No room was found
<% } %>
<%- include('partial/login-modal') %>

<div class="modal" id="reserveModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                Room reservation
            </div>
            <div class="modal-body">
                <div class="message"></div>
                <button class="btn btn-primary mt-3" data-dismiss="modal">
                    No problem, I'll wait.
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function reserveRoom(id) {
        $.ajax({
            url: '/rooms/reserve',
            method: 'POST',
            data: {id:id},
            success: function(res) {
                console.log(res);
                $('#reserveModal .message')
                    .text('Thank you for your interest. Room reservation needs to be confirmed by our staff. We will contact you soon.');
                $('#reserveModal').modal('show').on('hidden.bs.modal', function() { location.reload() });
            },
            error: function(res) {
                console.log(res);
                $('#reserveModal .message')
                    .text('Something was wrong. Please try again.');
                $('#reserveModal').modal('show');
            }
        })
    }
</script>
    